<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>访客管理后台（IP+地区表格版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.4/dist/sweetalert2.all.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF', danger: '#F53F3F', success: '#00B42A', neutral: '#F5F7FA'
          }
        }
      }
    }
  </script>
  <style> 
    .card-shadow { box-shadow: 0 2px 14px rgba(0,0,0,0.06); }
    .table-responsive { overflow-x: auto; }
  </style>
</head>
<body class="bg-neutral min-h-screen">
  <!-- 顶部导航 -->
  <header class="bg-white card-shadow sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold text-primary">访客管理系统（IP+地区统计）</h1>
      <button id="resetBtn" class="bg-danger hover:bg-danger/90 text-white px-4 py-2 rounded-lg transition-all">
        重置访客数据
      </button>
    </div>
  </header>

  <!-- 核心内容 -->
  <main class="container mx-auto px-4 py-8">
    <!-- 数据概览 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl card-shadow p-6 hover:shadow-md transition-all">
        <p class="text-gray-400 mb-2">总访客数</p>
        <h2 id="totalVisitors" class="text-3xl font-bold">0</h2>
      </div>
      <div class="bg-white rounded-xl card-shadow p-6 hover:shadow-md transition-all">
        <p class="text-gray-400 mb-2">今日访客数</p>
        <h2 id="todayVisitors" class="text-3xl font-bold text-primary">0</h2>
      </div>
      <div class="bg-white rounded-xl card-shadow p-6 hover:shadow-md transition-all">
        <p class="text-gray-400 mb-2">黑名单IP数</p>
        <h2 id="blacklistCount" class="text-3xl font-bold text-danger">0</h2>
      </div>
    </div>

    <!-- 图表区域 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-xl card-shadow p-6">
        <h3 class="text-lg font-semibold mb-4">近7天访客趋势</h3>
        <div class="h-80"><canvas id="sevenDaysChart"></canvas></div>
      </div>
      <div class="bg-white rounded-xl card-shadow p-6">
        <h3 class="text-lg font-semibold mb-4">TOP10 访客IP（含地区）</h3>
        <div class="h-80"><canvas id="topIpChart"></canvas></div>
      </div>
    </div>

    <!-- 新增：访客明细表格（IP+地区） -->
    <div class="bg-white rounded-xl card-shadow p-6 mb-8">
      <h3 class="text-lg font-semibold mb-4">访客明细（最新100条）</h3>
      <div class="table-responsive">
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr class="text-gray-600">
              <th class="py-3 px-4">ID</th>
              <th class="py-3 px-4">访客IP</th>
              <th class="py-3 px-4">归属地区</th>
              <th class="py-3 px-4">访问时间</th>
              <th class="py-3 px-4">设备信息</th>
            </tr>
          </thead>
          <tbody id="visitorTableBody" class="divide-y divide-gray-200">
            <tr class="text-center">
              <td colspan="5" class="py-8 text-gray-400">加载访客明细中...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 黑名单管理 -->
    <div class="bg-white rounded-xl card-shadow p-6 mb-8">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <h3 class="text-lg font-semibold">黑名单管理</h3>
        <button id="addBlacklistBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all">
          添加黑名单IP
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr class="text-gray-600">
              <th class="pb-3 px-2">ID</th>
              <th class="pb-3 px-2">拦截IP</th>
              <th class="pb-3 px-2">添加时间</th>
              <th class="pb-3 px-2">备注</th>
              <th class="pb-3 px-2">操作</th>
            </tr>
          </thead>
          <tbody id="blacklistTableBody" class="divide-y divide-gray-200">
            <tr class="text-center"><td colspan="5" class="py-8 text-gray-400">加载黑名单中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- 底部版权 -->
  <footer class="bg-white card-shadow py-4 text-center text-gray-400 text-sm">
    <p>© 2026 访客统计系统 | SQLite3 + Express + Chart.js | IP地区查询：ipapi.co</p>
  </footer>

  <script>
    // ！！！配置1：替换为你的Render后端域名
    const BACKEND_DOMAIN = 'https://visitor-server-wewv.onrender.com';
    // ！！！配置2：与.env中的ADMIN_KEY一致
    const ADMIN_KEY = 'Lmx%%112233';

    // 页面加载初始化
    window.onload = async () => {
      await loadStats();
      await loadBlacklist();
      initCharts();
    };

    // 加载统计数据（含访客明细表格）
    async function loadStats() {
      try {
        const res = await fetch(`${BACKEND_DOMAIN}/api/visitor/stats`);
        const { success, data } = await res.json();
        if (success) {
          // 更新概览数据
          document.getElementById('totalVisitors').textContent = data.totalVisitors;
          document.getElementById('todayVisitors').textContent = data.todayVisitors;
          window.chartData = data;

          // 渲染访客明细表格
          const visitorTbody = document.getElementById('visitorTableBody');
          if (data.visitorList.length === 0) {
            visitorTbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400">暂无访客数据</td></tr>';
          } else {
            visitorTbody.innerHTML = data.visitorList.map(item => `
              <tr class="hover:bg-gray-50">
                <td class="py-3 px-4">${item.id}</td>
                <td class="py-3 px-4 font-mono">${item.visitor_ip}</td>
                <td class="py-3 px-4 text-primary">${item.region}</td>
                <td class="py-3 px-4">${new Date(item.visit_time).toLocaleString()}</td>
                <td class="py-3 px-4 text-sm text-gray-500">${item.user_agent}</td>
              </tr>
            `).join('');
          }
        }
      } catch (err) {
        Swal.fire('错误', '加载统计数据失败', 'error');
      }
    }

    // 加载黑名单
    async function loadBlacklist() {
      try {
        const res = await fetch(`${BACKEND_DOMAIN}/api/blacklist`);
        const { success, data } = await res.json();
        if (success) {
          document.getElementById('blacklistCount').textContent = data.length;
          const tbody = document.getElementById('blacklistTableBody');
          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400">暂无黑名单数据</td></tr>';
            return;
          }
          tbody.innerHTML = data.map(item => `
            <tr class="hover:bg-gray-50">
              <td class="py-3 px-2">${item.id}</td>
              <td class="py-3 px-2 font-mono">${item.blocked_ip}</td>
              <td class="py-3 px-2">${new Date(item.add_time).toLocaleString()}</td>
              <td class="py-3 px-2">${item.remark}</td>
              <td class="py-3 px-2"><button onclick="delBlacklist(${item.id})" class="text-danger hover:text-danger/80">删除</button></td>
            </tr>
          `).join('');
        }
      } catch (err) {
        Swal.fire('错误', '加载黑名单失败', 'error');
      }
    }

    // 初始化图表
    function initCharts() {
      if (!window.chartData) return;
      const { sevenDaysTrend, topIpList } = window.chartData;
      
      // 近7天趋势图
      new Chart(document.getElementById('sevenDaysChart'), {
        type: 'line',
        data: {
          labels: sevenDaysTrend.map(i => i.visit_date),
          datasets: [{
            label: '访客数', data: sevenDaysTrend.map(i => i.visitor_count),
            borderColor: '#165DFF', backgroundColor: 'rgba(22,93,255,0.1)',
            tension: 0.3, fill: true
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      // TOP10 IP柱状图（显示地区）
      new Chart(document.getElementById('topIpChart'), {
        type: 'bar',
        data: {
          labels: topIpList.map(i => `${i.visitor_ip}<br>(${i.region})`),
          datasets: [{
            label: '访问次数', data: topIpList.map(i => i.visit_count),
            backgroundColor: 'rgba(22,93,255,0.7)', borderRadius: 4
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `访问次数：${context.raw}`;
                }
              }
            }
          }
        }
      });
    }

    // 重置数据
    document.getElementById('resetBtn').addEventListener('click', async () => {
      const result = await Swal.fire({
        title: '警告', text: '确定重置所有访客数据？不可恢复！',
        icon: 'warning', showCancelButton: true,
        confirmButtonText: '确定', cancelButtonText: '取消'
      });
      if (result.isConfirmed) {
        try {
          const res = await fetch(`${BACKEND_DOMAIN}/api/visitor/reset`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminKey: ADMIN_KEY })
          });
          const { success, msg } = await res.json();
          Swal.fire(success ? '成功' : '错误', msg, success ? 'success' : 'error');
          if (success) loadStats();
        } catch (err) {
          Swal.fire('错误', '重置失败', 'error');
        }
      }
    });

    // 添加黑名单
    document.getElementById('addBlacklistBtn').addEventListener('click', async () => {
      const { value } = await Swal.fire({
        title: '添加黑名单IP',
        html: `
          <input id="ip" class="swal2-input mb-3" placeholder="输入IP地址">
          <input id="remark" class="swal2-input" placeholder="备注（可选）">
        `,
        preConfirm: () => ({ ip: document.getElementById('ip').value, remark: document.getElementById('remark').value })
      });
      if (value?.ip) {
        try {
          const res = await fetch(`${BACKEND_DOMAIN}/api/blacklist/add`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(value)
          });
          const { success, msg } = await res.json();
          Swal.fire(success ? '成功' : '错误', msg, success ? 'success' : 'error');
          if (success) loadBlacklist();
        } catch (err) {
          Swal.fire('错误', '添加失败', 'error');
        }
      }
    });

    // 删除黑名单
    async function delBlacklist(id) {
      const result = await Swal.fire({
        title: '确定删除？', text: '删除后该IP可正常访问',
        icon: 'question', showCancelButton: true
      });
      if (result.isConfirmed) {
        try {
          const res = await fetch(`${BACKEND_DOMAIN}/api/blacklist/delete/${id}`, { method: 'DELETE' });
          const { success, msg } = await res.json();
          Swal.fire(success ? '成功' : '错误', msg, success ? 'success' : 'error');
          if (success) loadBlacklist();
        } catch (err) {
          Swal.fire('错误', '删除失败', 'error');
        }
      }
    }
  </script>
</body>
</html>