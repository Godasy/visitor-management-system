<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>访客管理后台</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Chart.js（图表可视化） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <!-- 引入SweetAlert2（精美弹窗） -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.4/dist/sweetalert2.all.min.js"></script>
  <!-- 配置Tailwind自定义主题 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            danger: '#F53F3F',
            success: '#00B42A',
            neutral: '#F5F7FA',
            gray: {
              100: '#F7F8FA',
              200: '#E5E6EB',
              300: '#C9CDD4',
              400: '#86909C',
              500: '#4E5969',
              600: '#272E3B',
              700: '#1D2129',
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 2px 14px rgba(0, 0, 0, 0.06);
      }
    }
  </style>
</head>
<body class="bg-neutral font-sans text-gray-700 min-h-screen">
  <!-- 顶部导航栏 -->
  <header class="bg-white card-shadow sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold text-primary">访客管理系统</h1>
      <button id="resetBtn" class="bg-danger hover:bg-danger/90 text-white px-4 py-2 rounded-lg transition-all">
        重置所有访客数据
      </button>
    </div>
  </header>

  <!-- 核心内容区域 -->
  <main class="container mx-auto px-4 py-8">
    <!-- 数据概览卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl card-shadow p-6 transition-all hover:shadow-md">
        <p class="text-gray-400 mb-2">总访客数</p>
        <h2 id="totalVisitors" class="text-3xl font-bold text-gray-700">0</h2>
      </div>
      <div class="bg-white rounded-xl card-shadow p-6 transition-all hover:shadow-md">
        <p class="text-gray-400 mb-2">今日访客数</p>
        <h2 id="todayVisitors" class="text-3xl font-bold text-primary">0</h2>
      </div>
      <div class="bg-white rounded-xl card-shadow p-6 transition-all hover:shadow-md">
        <p class="text-gray-400 mb-2">黑名单IP数</p>
        <h2 id="blacklistCount" class="text-3xl font-bold text-danger">0</h2>
      </div>
    </div>

    <!-- 图表区域 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- 近7天访客趋势图 -->
      <div class="bg-white rounded-xl card-shadow p-6">
        <h3 class="text-lg font-semibold mb-4">近7天访客趋势</h3>
        <div class="h-80">
          <canvas id="sevenDaysChart"></canvas>
        </div>
      </div>

      <!-- TOP10访客IP柱状图 -->
      <div class="bg-white rounded-xl card-shadow p-6">
        <h3 class="text-lg font-semibold mb-4">TOP10 访客IP</h3>
        <div class="h-80">
          <canvas id="topIpChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 黑名单管理区域 -->
    <div class="bg-white rounded-xl card-shadow p-6 mb-8">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <h3 class="text-lg font-semibold">黑名单管理</h3>
        <button id="addBlacklistBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all">
          添加黑名单IP
        </button>
      </div>

      <!-- 黑名单表格 -->
      <div class="overflow-x-auto">
        <table class="w-full text-left">
          <thead class="border-b border-gray-200">
            <tr class="text-gray-500">
              <th class="pb-3 px-2">ID</th>
              <th class="pb-3 px-2">被拦截IP</th>
              <th class="pb-3 px-2">添加时间</th>
              <th class="pb-3 px-2">备注</th>
              <th class="pb-3 px-2">操作</th>
            </tr>
          </thead>
          <tbody id="blacklistTableBody">
            <!-- 黑名单数据通过JS动态渲染 -->
            <tr class="text-center">
              <td colspan="5" class="py-8 text-gray-400">加载中...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- 底部版权信息 -->
  <footer class="bg-white card-shadow py-4 text-center text-gray-400 text-sm">
    <p>© 2026 访客统计管理系统 | 技术支持：Node.js + PostgreSQL + Chart.js</p>
  </footer>

  <!-- 核心功能JS -->
  <script>
    // 全局变量：管理员密钥（需与后端.env文件中的ADMIN_KEY一致）
    const ADMIN_KEY = 'your_custom_admin_secret_key_123';

    // 1. 页面加载完成后初始化所有数据
    window.onload = async () => {
      await loadVisitorStats(); // 加载访客统计数据
      await loadBlacklist(); // 加载黑名单数据
      initCharts(); // 初始化图表
    };

    // 2. 加载访客统计数据
    async function loadVisitorStats() {
      try {
        const response = await fetch('/api/visitor/stats');
        const result = await response.json();

        if (result.success) {
          const { totalVisitors, todayVisitors } = result.data;
          // 更新概览卡片数据
          document.getElementById('totalVisitors').textContent = totalVisitors;
          document.getElementById('todayVisitors').textContent = todayVisitors;

          // 存储图表数据（供图表初始化使用）
          window.sevenDaysData = result.data.sevenDaysTrend;
          window.topIpData = result.data.topIpList;
        } else {
          Swal.fire('错误', result.msg, 'error');
        }
      } catch (err) {
        console.error('加载访客统计失败：', err);
        Swal.fire('错误', '加载访客数据失败', 'error');
      }
    }

    // 3. 加载黑名单数据
    async function loadBlacklist() {
      try {
        const response = await fetch('/api/blacklist');
        const result = await response.json();

        if (result.success) {
          const blacklist = result.data;
          const tableBody = document.getElementById('blacklistTableBody');
          
          // 更新黑名单数量
          document.getElementById('blacklistCount').textContent = blacklist.length;

          // 渲染黑名单表格
          if (blacklist.length === 0) {
            tableBody.innerHTML = '<tr class="text-center"><td colspan="5" class="py-8 text-gray-400">暂无黑名单数据</td></tr>';
            return;
          }

          tableBody.innerHTML = '';
          blacklist.forEach(item => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-100 hover:bg-gray-50';
            tr.innerHTML = `
              <td class="py-3 px-2">${item.id}</td>
              <td class="py-3 px-2 font-mono">${item.blocked_ip}</td>
              <td class="py-3 px-2">${new Date(item.add_time).toLocaleString()}</td>
              <td class="py-3 px-2">${item.remark}</td>
              <td class="py-3 px-2">
                <button class="deleteBlacklistBtn text-danger hover:text-danger/80 transition-all" data-id="${item.id}">
                  删除
                </button>
              </td>
            `;
            tableBody.appendChild(tr);
          });

          // 绑定删除按钮事件
          document.querySelectorAll('.deleteBlacklistBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const id = e.target.dataset.id;
              await deleteBlacklist(id);
            });
          });
        } else {
          Swal.fire('错误', result.msg, 'error');
        }
      } catch (err) {
        console.error('加载黑名单失败：', err);
        Swal.fire('错误', '加载黑名单数据失败', 'error');
      }
    }

    // 4. 初始化图表
    function initCharts() {
      // 近7天访客趋势图（折线图）
      const sevenDaysCtx = document.getElementById('sevenDaysChart').getContext('2d');
      const sevenDaysLabels = window.sevenDaysData.map(item => item.visit_date);
      const sevenDaysValues = window.sevenDaysData.map(item => parseInt(item.visitor_count));

      new Chart(sevenDaysCtx, {
        type: 'line',
        data: {
          labels: sevenDaysLabels,
          datasets: [{
            label: '访客数量',
            data: sevenDaysValues,
            backgroundColor: 'rgba(22, 93, 255, 0.1)',
            borderColor: '#165DFF',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      // TOP10访客IP柱状图
      const topIpCtx = document.getElementById('topIpChart').getContext('2d');
      const topIpLabels = window.topIpData.map(item => item.visitor_ip);
      const topIpValues = window.topIpData.map(item => parseInt(item.visit_count));

      new Chart(topIpCtx, {
        type: 'bar',
        data: {
          labels: topIpLabels,
          datasets: [{
            label: '访问次数',
            data: topIpValues,
            backgroundColor: 'rgba(22, 93, 255, 0.7)',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // 5. 重置访客数据
    document.getElementById('resetBtn').addEventListener('click', async () => {
      // 确认弹窗
      const result = await Swal.fire({
        title: '警告',
        text: '确定要重置所有访客数据吗？此操作不可恢复！',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#F53F3F',
        cancelButtonColor: '#4E5969',
        confirmButtonText: '确定重置',
        cancelButtonText: '取消'
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch('/api/visitor/reset', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ adminKey: ADMIN_KEY })
          });

          const data = await response.json();
          if (data.success) {
            Swal.fire('成功', data.msg, 'success');
            await loadVisitorStats(); // 重新加载数据
            window.location.reload(); // 刷新页面重置图表
          } else {
            Swal.fire('错误', data.msg, 'error');
          }
        } catch (err) {
          console.error('重置访客数据失败：', err);
          Swal.fire('错误', '重置数据失败', 'error');
        }
      }
    });

    // 6. 添加黑名单IP
    document.getElementById('addBlacklistBtn').addEventListener('click', async () => {
      // 弹窗表单
      const { value: formValues } = await Swal.fire({
        title: '添加黑名单IP',
        html: `
          <input id="ipInput" class="swal2-input w-full mb-3 px-3 py-2 border border-gray-300 rounded-lg" placeholder="请输入IP地址（IPv4/IPv6）">
          <input id="remarkInput" class="swal2-input w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="请输入备注（可选）">
        `,
        focusConfirm: false,
        preConfirm: () => {
          return {
            ip: document.getElementById('ipInput').value,
            remark: document.getElementById('remarkInput').value
          };
        }
      });

      if (formValues && formValues.ip) {
        try {
          const response = await fetch('/api/blacklist/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ip: formValues.ip,
              remark: formValues.remark
            })
          });

          const data = await response.json();
          if (data.success) {
            Swal.fire('成功', data.msg, 'success');
            await loadBlacklist(); // 重新加载黑名单
          } else {
            Swal.fire('错误', data.msg, 'error');
          }
        } catch (err) {
          console.error('添加黑名单失败：', err);
          Swal.fire('错误', '添加黑名单失败', 'error');
        }
      }
    });

    // 7. 删除黑名单IP
    async function deleteBlacklist(id) {
      // 确认弹窗
      const result = await Swal.fire({
        title: '确定删除？',
        text: '删除后该IP将可以正常访问',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#165DFF',
        cancelButtonColor: '#4E5969',
        confirmButtonText: '确定删除',
        cancelButtonText: '取消'
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch(`/api/blacklist/delete/${id}`, {
            method: 'DELETE'
          });

          const data = await response.json();
          if (data.success) {
            Swal.fire('成功', data.msg, 'success');
            await loadBlacklist(); // 重新加载黑名单
          } else {
            Swal.fire('错误', data.msg, 'error');
          }
        } catch (err) {
          console.error('删除黑名单失败：', err);
          Swal.fire('错误', '删除黑名单失败', 'error');
        }
      }
    }
  </script>
</body>
</html>